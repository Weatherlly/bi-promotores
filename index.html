<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Comercial - Super Raimundinho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Estilo para o select múltiplo parecer mais moderno */
        select[multiple] { height: 100px; padding: 8px; }
        select[multiple] option { padding: 8px; border-radius: 6px; margin-bottom: 2px; }
        select[multiple] option:checked { background: #2563eb linear-gradient(0deg, #2563eb 0%, #2563eb 100%); color: white; }
    </style>
</head>
<body class="p-0 m-0 text-slate-800">

    <nav class="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black uppercase italic tracking-tighter">BI Promotores</h1>
                <p class="text-[10px] opacity-70">Filtros Avançados: Datas e Multilojas</p>
            </div>
            <div id="status" class="bg-blue-800 px-4 py-2 rounded-full text-[10px] font-bold border border-blue-600 tracking-widest">
                SINCRONIZANDO...
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 lg:p-8">
        
        <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Unidade Loja (Ctrl + Clique)</label>
                <select id="f-loja" onchange="atualizarInterface()" multiple class="w-full bg-slate-50 border border-slate-200 rounded-xl text-sm outline-blue-600"></select>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Empresa/Fornecedor</label>
                <select id="f-empresa" onchange="atualizarInterface()" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm outline-blue-600">
                    <style>select:not([multiple]) { appearance: auto; }</style>
                </select>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Período (Início e Fim)</label>
                <div class="grid grid-cols-2 gap-2">
                    <input type="date" id="f-data-inicio" onchange="atualizarInterface()" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-xs outline-blue-600">
                    <input type="date" id="f-data-fim" onchange="atualizarInterface()" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-xs outline-blue-600">
                </div>
                <button onclick="limparDatas()" class="mt-2 text-[9px] text-blue-600 font-bold uppercase hover:underline">Limpar Datas</button>
            </div>
            <div class="flex items-end">
                <button onclick="location.reload()" class="w-full bg-slate-900 text-white font-bold p-4 rounded-xl hover:bg-black transition shadow-lg shadow-slate-200 uppercase text-xs">
                    Atualizar Dados
                </button>
            </div>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-blue-600">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Total Entradas</p>
                <span id="k-total" class="text-4xl font-black italic text-slate-900">0</span>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-emerald-500">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Empresas</p>
                <span id="k-empresas" class="text-4xl font-black italic text-slate-900">0</span>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-purple-500">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Lojas Ativas</p>
                <span id="k-lojas" class="text-4xl font-black italic text-slate-900">0</span>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="text-sm font-bold text-slate-500 uppercase mb-6 text-center italic">Participação por Loja</h3>
                <div class="chart-container"><canvas id="c-loja"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="text-sm font-bold text-slate-500 uppercase mb-6 text-center italic">Top Fornecedores</h3>
                <div class="chart-container"><canvas id="c-forn"></canvas></div>
            </div>
        </section>

        <section class="bg-white rounded-3xl shadow-sm overflow-hidden border border-slate-200">
            <div class="p-6 bg-slate-50 border-b border-slate-200">
                <h3 class="font-bold text-sm uppercase italic text-slate-600">Registros Filtrados</h3>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
                <table class="w-full text-left">
                    <thead class="bg-white sticky top-0 shadow-sm border-b border-slate-100">
                        <tr class="text-[10px] text-slate-400 font-bold uppercase">
                            <th class="p-6">Data/Hora</th>
                            <th class="p-6">Colaborador</th>
                            <th class="p-6">Empresa</th>
                            <th class="p-6">Loja</th>
                        </tr>
                    </thead>
                    <tbody id="t-corpo" class="text-sm divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const SHEET_ID = '13SKsqWIa-GpdIGnIkMnXGuGrIhbovlMD6wtAjIv_Li4';
        const G_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

        let masterData = [];
        let chart1, chart2;

        function formatarDataBR(val) {
            if (!val) return '-';
            if (typeof val === 'string' && val.includes('Date')) {
                const match = val.match(/\d+/g);
                if (match) {
                    return `${match[2].padStart(2,'0')}/${(parseInt(match[1])+1).toString().padStart(2,'0')}/${match[0]} ${match[3].padStart(2,'0')}:${match[4].padStart(2,'0')}`;
                }
            }
            return val;
        }

        // Converte a data do Google para objeto Date real do JS para comparação
        function parseGoogleDate(val) {
            if (typeof val === 'string' && val.includes('Date')) {
                const m = val.match(/\d+/g);
                return new Date(m[0], m[1], m[2]);
            }
            return null;
        }

        async function init() {
            try {
                const response = await fetch(G_URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
                const rows = json.table.rows;
                const cols = json.table.cols;

                masterData = rows.map(row => {
                    let obj = {};
                    row.c.forEach((cell, i) => {
                        const label = cols[i].label;
                        if (label) {
                            obj[label] = cell ? cell.v : '';
                            // Adiciona campo de data real para o filtro
                            if(label === 'Carimbo de data/hora') obj._jsDate = parseGoogleDate(cell.v);
                        }
                    });
                    return obj;
                }).filter(d => d.Empresa);

                document.getElementById('status').innerText = "ONLINE";
                document.getElementById('status').className = "bg-emerald-500 px-4 py-2 rounded-full text-[10px] font-bold";

                setupFiltros();
                atualizarInterface();
            } catch (error) {
                document.getElementById('status').innerText = "ERRO DE CONEXÃO";
                document.getElementById('status').className = "bg-red-600 px-4 py-2 rounded-full text-[10px] font-bold";
            }
        }

        function setupFiltros() {
            const lojas = [...new Set(masterData.map(d => d['Super Raimundinho']))].filter(Boolean).sort();
            const empresas = ["Todas as Empresas", ...new Set(masterData.map(d => d.Empresa))].filter(Boolean).sort();
            
            // Renderiza lojas (Sem a opção "Todas" no múltiplo, o usuário seleciona as que quer)
            document.getElementById('f-loja').innerHTML = lojas.map(l => `<option value="${l}" selected>${l}</option>`).join('');
            document.getElementById('f-empresa').innerHTML = empresas.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function limparDatas() {
            document.getElementById('f-data-inicio').value = '';
            document.getElementById('f-data-fim').value = '';
            atualizarInterface();
        }

        function atualizarInterface() {
            // Pega múltiplas lojas selecionadas
            const lojasSelecionadas = Array.from(document.getElementById('f-loja').selectedOptions).map(opt => opt.value);
            const fEmpresa = document.getElementById('f-empresa').value;
            const dataInicio = document.getElementById('f-data-inicio').value;
            const dataFim = document.getElementById('f-data-fim').value;

            const dados = masterData.filter(d => {
                // Filtro de Loja
                const checkLoja = lojasSelecionadas.length === 0 || lojasSelecionadas.includes(d['Super Raimundinho']);
                
                // Filtro de Empresa
                const checkEmp = fEmpresa === "Todas as Empresas" || d.Empresa === fEmpresa;
                
                // Filtro de Datas
                let checkData = true;
                if (d._jsDate) {
                    if (dataInicio) {
                        const dIni = new Date(dataInicio + "T00:00:00");
                        if (d._jsDate < dIni) checkData = false;
                    }
                    if (dataFim) {
                        const dFim = new Date(dataFim + "T23:59:59");
                        if (d._jsDate > dFim) checkData = false;
                    }
                }

                return checkLoja && checkEmp && checkData;
            });

            document.getElementById('k-total').innerText = dados.length;
            document.getElementById('k-empresas').innerText = new Set(dados.map(d => d.Empresa)).size;
            document.getElementById('k-lojas').innerText = new Set(dados.map(d => d['Super Raimundinho'])).size;

            renderCharts(dados);
            renderTabela(dados);
        }

        function renderCharts(dados) {
            const ctx1 = document.getElementById('c-loja').getContext('2d');
            const ctx2 = document.getElementById('c-forn').getContext('2d');
            const countsLoja = agrupar(dados, 'Super Raimundinho');
            const countsForn = Object.entries(agrupar(dados, 'Empresa')).sort((a,b)=>b[1]-a[1]).slice(0, 10);

            if(chart1) chart1.destroy();
            chart1 = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(countsLoja),
                    datasets: [{ data: Object.values(countsLoja), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'], borderWidth: 2, borderColor: '#fff' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });

            if(chart2) chart2.destroy();
            chart2 = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: countsForn.map(x => x[0]),
                    datasets: [{ label: 'Visitas', data: countsForn.map(x => x[1]), backgroundColor: '#3b82f6', borderRadius: 8 }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        function renderTabela(dados) {
            const tbody = document.getElementById('t-corpo');
            tbody.innerHTML = dados.slice().reverse().map(d => `
                <tr class="hover:bg-blue-50 transition-colors uppercase text-[11px]">
                    <td class="px-6 py-4 text-slate-400 font-mono italic">${formatarDataBR(d['Carimbo de data/hora'])}</td>
                    <td class="px-6 py-4 font-bold text-slate-700">${d['Nome coloborador:'] || '-'}</td>
                    <td class="px-6 py-4 text-blue-600 font-bold">${d.Empresa || '-'}</td>
                    <td class="px-6 py-4"><span class="bg-slate-100 px-2 py-1 rounded-lg border border-slate-200 text-slate-500 font-medium">${d['Super Raimundinho'] || '-'}</span></td>
                </tr>
            `).join('');
        }

        function agrupar(arr, key) {
            return arr.reduce((acc, curr) => {
                const val = curr[key] || 'Outros';
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
        }

        init();
    </script>
</body>
</html>
