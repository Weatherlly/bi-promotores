<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Comercial - Super Raimundinho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        select[multiple] { height: 120px; padding: 8px; border: 2px solid #e2e8f0; width: 100%; border-radius: 12px; background-color: #f8fafc; outline: none; }
        select[multiple] option { padding: 6px 10px; border-radius: 6px; margin-bottom: 2px; font-size: 11px; }
        select[multiple] option:checked { background: #2563eb linear-gradient(0deg, #2563eb 0%, #2563eb 100%); color: white; }
    </style>
</head>
<body class="p-0 m-0 text-slate-800">

    <nav class="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black uppercase italic tracking-tighter">BI Promotores</h1>
                <p class="text-[10px] opacity-70">Controle de Fluxo e Permanência - Super Raimundinho</p>
            </div>
            <div id="status" class="bg-blue-800 px-4 py-2 rounded-full text-[10px] font-bold border border-blue-600 tracking-widest">
                SINCRONIZANDO...
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 lg:p-8">
        
        <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Unidades (Lojas)</label>
                <select id="f-loja" onchange="atualizarInterface()" multiple></select>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Empresas (Fornecedores)</label>
                <select id="f-empresa" onchange="atualizarInterface()" multiple></select>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Período</label>
                <div class="flex flex-col gap-2">
                    <input type="date" id="f-data-inicio" onchange="atualizarInterface()" class="bg-slate-50 border border-slate-200 p-2 rounded-lg text-xs outline-blue-600">
                    <input type="date" id="f-data-fim" onchange="atualizarInterface()" class="bg-slate-50 border border-slate-200 p-2 rounded-lg text-xs outline-blue-600">
                    <button onclick="limparDatas()" class="text-[9px] text-blue-600 font-bold uppercase hover:underline text-left">Limpar Período</button>
                </div>
            </div>
            <div class="flex items-end">
                <button onclick="location.reload()" class="w-full bg-slate-900 text-white font-bold p-4 rounded-xl hover:bg-black transition shadow-lg shadow-slate-200 uppercase text-xs">
                    Atualizar Agora
                </button>
            </div>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-blue-600">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Total Registros</p>
                <span id="k-total" class="text-3xl font-black italic">0</span>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-emerald-500">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Empresas</p>
                <span id="k-empresas" class="text-3xl font-black italic">0</span>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-purple-500">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Tempo Médio</p>
                <span id="k-media" class="text-3xl font-black italic text-purple-600">00:00h</span>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border-b-4 border-orange-500">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Visitas Concluídas</p>
                <span id="k-concluidas" class="text-3xl font-black italic">0</span>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="lg:col-span-2 bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200">
                    <h3 class="font-bold text-xs uppercase italic text-slate-600">Duração por Visita (Entrada x Saída)</h3>
                </div>
                <div class="overflow-y-auto h-[300px]">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-white sticky top-0 shadow-sm border-b border-slate-100">
                            <tr class="text-slate-400 font-bold uppercase">
                                <th class="p-4">Promotor</th>
                                <th class="p-4">Loja</th>
                                <th class="p-4">Data</th>
                                <th class="p-4 text-center">Duração</th>
                            </tr>
                        </thead>
                        <tbody id="t-duracao" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-center items-center">
                <h3 class="text-sm font-bold text-slate-500 uppercase mb-4 italic text-center">Participação por Loja</h3>
                <div class="chart-container"><canvas id="c-loja"></canvas></div>
            </div>
        </section>

        <section class="bg-white rounded-3xl shadow-sm overflow-hidden border border-slate-200">
            <div class="p-6 bg-slate-50 border-b border-slate-200">
                <h3 class="font-bold text-sm uppercase italic text-slate-600">Log Completo de Movimentação</h3>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
                <table class="w-full text-left">
                    <thead class="bg-white sticky top-0 shadow-sm border-b border-slate-100">
                        <tr class="text-[10px] text-slate-400 font-bold uppercase">
                            <th class="p-6">Data/Hora</th>
                            <th class="p-6">Movimentação</th>
                            <th class="p-6">Colaborador</th>
                            <th class="p-6">Empresa</th>
                            <th class="p-6">Loja</th>
                        </tr>
                    </thead>
                    <tbody id="t-corpo" class="text-sm divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const SHEET_ID = '13SKsqWIa-GpdIGnIkMnXGuGrIhbovlMD6wtAjIv_Li4';
        const G_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

        let masterData = [];
        let chart1;

        // Formata Data/Hora: DD/MM/YYYY HH:MM
        function formatarDataBR(val) {
            if (!val) return '-';
            if (typeof val === 'string' && val.includes('Date')) {
                const m = val.match(/\d+/g);
                return `${m[2].padStart(2,'0')}/${(parseInt(m[1])+1).toString().padStart(2,'0')}/${m[0]} ${m[3].padStart(2,'0')}:${m[4].padStart(2,'0')}`;
            }
            return val;
        }

        // Converte string do Google para Date do JS
        function parseGoogleDateTime(val) {
            if (typeof val === 'string' && val.includes('Date')) {
                const m = val.match(/\d+/g);
                return new Date(m[0], m[1], m[2], m[3], m[4], m[5]);
            }
            return null;
        }

        async function init() {
            try {
                const response = await fetch(G_URL);
                const text = await response.text();
                const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                const rows = json.table.rows;
                const cols = json.table.cols;

                masterData = rows.map(row => {
                    let obj = {};
                    row.c.forEach((cell, i) => {
                        const label = cols[i].label || `col_${i}`;
                        // Mapeia os dados usando f (formatado) ou v (valor)
                        obj[label] = cell ? (cell.f || cell.v) : '';
                        
                        if (label === 'Carimbo de data/hora' && cell) {
                            obj._jsDate = parseGoogleDateTime(cell.v);
                        }
                    });
                    return obj;
                }).filter(d => d.Empresa);

                setupFiltros();
                atualizarInterface();
                document.getElementById('status').innerText = "ONLINE";
                document.getElementById('status').className = "bg-emerald-500 px-4 py-2 rounded-full text-[10px] font-bold";
            } catch (e) {
                console.error(e);
                document.getElementById('status').innerText = "ERRO";
            }
        }

        function setupFiltros() {
            const lojas = [...new Set(masterData.map(d => d['Super Raimundinho']))].filter(Boolean).sort();
            const empresas = [...new Set(masterData.map(d => d.Empresa))].filter(Boolean).sort();
            
            document.getElementById('f-loja').innerHTML = `<option value="Todas" selected>Todas as Lojas</option>` + lojas.map(l => `<option value="${l}">${l}</option>`).join('');
            document.getElementById('f-empresa').innerHTML = `<option value="Todas" selected>Todas as Empresas</option>` + empresas.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function limparDatas() {
            document.getElementById('f-data-inicio').value = '';
            document.getElementById('f-data-fim').value = '';
            atualizarInterface();
        }

        function atualizarInterface() {
            const selLojas = Array.from(document.getElementById('f-loja').selectedOptions).map(o => o.value);
            const selEmps = Array.from(document.getElementById('f-empresa').selectedOptions).map(o => o.value);
            const dIni = document.getElementById('f-data-inicio').value;
            const dFim = document.getElementById('f-data-fim').value;

            const dados = masterData.filter(d => {
                const checkLoja = selLojas.includes("Todas") || selLojas.includes(d['Super Raimundinho']);
                const checkEmp = selEmps.includes("Todas") || selEmps.includes(d.Empresa);
                let checkData = true;
                if (d._jsDate) {
                    if (dIni) if (d._jsDate < new Date(dIni + "T00:00:00")) checkData = false;
                    if (dFim) if (d._jsDate > new Date(dFim + "T23:59:59")) checkData = false;
                }
                return checkLoja && checkEmp && checkData;
            });

            document.getElementById('k-total').innerText = dados.length;
            document.getElementById('k-empresas').innerText = new Set(dados.map(d => d.Empresa)).size;
            
            calcularPermanencia(dados);
            renderCharts(dados);
            renderTabelaGeral(dados);
        }

        function calcularPermanencia(dados) {
            let visitas = [];
            const grupos = {};
            
            // Agrupamos registros por Colaborador + Loja + Data (Dia)
            dados.forEach(d => {
                if (!d._jsDate) return;
                const dia = d._jsDate.toLocaleDateString();
                const key = `${d['Nome coloborador:']}_${d['Super Raimundinho']}_${dia}`;
                if (!grupos[key]) grupos[key] = [];
                grupos[key].push(d);
            });

            let somaMinutos = 0;
            let totalConcluidas = 0;

            for (let key in grupos) {
                const registros = grupos[key].sort((a,b) => a._jsDate - b._jsDate);
                // Procura a entrada e a saída usando o nome exato da sua coluna G: "Entrada / Saida"
                const entrada = registros.find(r => r['Entrada / Saida'] === 'Entrada');
                const saida = registros.find(r => r['Entrada / Saida'] === 'Saida');

                if (entrada && saida && saida._jsDate > entrada._jsDate) {
                    const diffMs = saida._jsDate - entrada._jsDate;
                    const diffMin = Math.floor(diffMs / 60000);
                    
                    // Validação: Visitas reais costumam durar entre 1 min e 12 horas
                    if (diffMin > 0 && diffMin < 720) {
                        visitas.push({
                            nome: entrada['Nome coloborador:'],
                            loja: entrada['Super Raimundinho'],
                            data: entrada._jsDate.toLocaleDateString('pt-BR'),
                            duracao: diffMin
                        });
                        somaMinutos += diffMin;
                        totalConcluidas++;
                    }
                }
            }

            document.getElementById('k-concluidas').innerText = totalConcluidas;
            const media = totalConcluidas > 0 ? Math.round(somaMinutos / totalConcluidas) : 0;
            const h = Math.floor(media / 60);
            const m = media % 60;
            document.getElementById('k-media').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}h`;

            const tbody = document.getElementById('t-duracao');
            tbody.innerHTML = visitas.slice().reverse().map(v => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-4 font-bold text-slate-700">${v.nome}</td>
                    <td class="p-4 text-slate-500">${v.loja}</td>
                    <td class="p-4 text-slate-400 font-mono">${v.data}</td>
                    <td class="p-4 text-center"><span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-md font-bold">${v.duracao} min</span></td>
                </tr>
            `).join('');
        }

        function renderCharts(dados) {
            const ctx1 = document.getElementById('c-loja').getContext('2d');
            const countsLoja = agrupar(dados, 'Super Raimundinho');
            if(chart1) chart1.destroy();
            chart1 = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(countsLoja),
                    datasets: [{ 
                        data: Object.values(countsLoja), 
                        backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'], 
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } } 
                }
            });
        }

        function renderTabelaGeral(dados) {
            const tbody = document.getElementById('t-corpo');
            tbody.innerHTML = dados.slice().reverse().map(d => {
                const tipo = d['Entrada / Saida'] || '-';
                const corTipo = tipo === 'Entrada' ? 'text-emerald-600 bg-emerald-50' : (tipo === 'Saida' ? 'text-red-600 bg-red-50' : 'text-slate-400');
                
                return `
                <tr class="hover:bg-blue-50 transition-colors uppercase text-[11px]">
                    <td class="px-6 py-4 text-slate-400 font-mono italic">${formatarDataBR(d['Carimbo de data/hora'])}</td>
                    <td class="px-6 py-4 font-bold">
                        <span class="px-3 py-1 rounded-full ${corTipo}">
                            ${tipo}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">${d['Nome coloborador:'] || '-'}</td>
                    <td class="px-6 py-4 text-blue-600 font-bold">${d.Empresa || '-'}</td>
                    <td class="px-6 py-4"><span class="bg-slate-100 px-2 py-1 rounded-lg border border-slate-200 text-slate-500 font-medium">${d['Super Raimundinho'] || '-'}</span></td>
                </tr>
                `;
            }).join('');
        }

        function agrupar(arr, key) {
            return arr.reduce((acc, curr) => {
                const val = curr[key] || 'Outros';
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
        }

        init();
    </script>
</body>
</html>
